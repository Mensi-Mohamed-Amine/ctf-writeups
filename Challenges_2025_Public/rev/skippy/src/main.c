#include <stdio.h>
#include <string.h>
#include <stdint.h>
#include "aes.h"

uint8_t precomputed[] = { 0xae,0x27,0x24,0x1b,0x7f,0xfd,0x2c,0x8b,0x32,0x65,0xf2,0x2a,0xd1,0xb0,0x63,0xf0,0x91,0x5b,0x6b,0x95,0xdc,0xc0,0xee,0xc1,0x4d,0xe2,0xc5,0x63,0xf7,0x71,0x55,0x94,0x00,0x7d,0x2b,0xc7,0x5e,0x5d,0x61,0x4e,0x5e,0x51,0x19,0x0f,0x4a,0xd1,0xfd,0x21,0xc5,0xc4,0xb1,0xab,0x89,0xa4,0xa7,0x25,0xc5,0xb8,0xed,0x3c,0xb3,0x76,0x30,0x72,0x7b,0x2d,0x2a,0xb7,0x22,0xdc,0x93,0x33,0x26,0x47,0x25,0xc6,0xb5,0xdd,0xb0,0x0d,0xd3,0xc3,0xda,0x63,0x13,0xf1,0xe2,0xf4,0xdf,0x51,0x80,0xd5,0xf3,0x83,0x18,0x43 };


void decryptor(uint8_t *input) {
    fprintf(stderr, "Uh oh... Skippy sees a null zone in the way...\n");
    fflush(stderr);
    int* i = NULL;
	printf("%d\n", *i);
    for (size_t i = 0; i < 16; i++) {
        input[i] = (input[i] >> 1) & 0xFF;
    }
}

void stone(uint8_t *stumble){
    const char* trip = "Oh no! Skippy is about to trip!";
    fprintf(stderr, "%s\n", trip);
    fflush(stderr);
	char* fall = (char*) trip;
	fall[0] = stumble[0];
}

void sandwich(uint8_t *something){
    stone(something);
    decryptor(something);
    stone(something);
}

void decrypt_bytestring(const uint8_t *key, const uint8_t *iv) {
    struct AES_ctx ctx;
    size_t ciphertext_len = sizeof(precomputed);
    uint8_t decrypted[ciphertext_len + 1];
    memcpy(decrypted, precomputed, ciphertext_len);
    AES_init_ctx_iv(&ctx, key, iv);
    AES_CBC_decrypt_buffer(&ctx, decrypted, ciphertext_len);
    decrypted[ciphertext_len] = '\0';
    stone(decrypted);
    printf("%s\n", decrypted);
}

int main() {
    uint8_t key[] = { 0xe6, 0xd6, 0xd2, 0xe0, 0xe0, 0xf2, 0xbe, 0xe8, 0xd0, 0xca, 0xbe, 0xc4, 0xea, 0xe6, 0xd0, 0xbe, 0x40 };
    sandwich(key);
    uint8_t iv[] = { 0xd6, 0xc2, 0xdc, 0xce, 0xc2, 0xe4, 0xde, 0xde, 0xde, 0xde, 0xde, 0xde, 0xde, 0xde, 0xde, 0xde, 0x40 };
    sandwich(iv);
    decrypt_bytestring((uint8_t *)key, (uint8_t *)iv);
    return 0;
}
